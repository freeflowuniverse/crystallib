<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="x-ua-compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>natsclient | vdoc</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="manifest" href="site.webmanifest">
  <link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  
		<link rel="stylesheet" href="doc.css" />
		<link rel="stylesheet" href="normalize.css" />
		<script src="dark-mode.js"></script>
</head>

<body>
  <div><a id="skip-to-content-link" href="#main-content">Skip to content</a></div>
  <div id="page">
    <header class="doc-nav hidden">
      <div class="heading-container">
        <div class="heading">
          <div class="info">
            <div class="module">crystallib</div>
            <div class="toggle-version-container">
              <span>0.1.0 2179db3</span>
              <div id="dark-mode-toggle" role="switch" aria-checked="false" aria-label="Toggle dark mode"><svg xmlns="http://www.w3.org/2000/svg" class="light-icon" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.79 1.42-1.41zM4 10.5H1v2h3v-2zm9-9.95h-2V3.5h2V.55zm7.45 3.91l-1.41-1.41-1.79 1.79 1.41 1.41 1.79-1.79zm-3.21 13.7l1.79 1.8 1.41-1.41-1.8-1.79-1.4 1.4zM20 10.5v2h3v-2h-3zm-8-5c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm-1 16.95h2V19.5h-2v2.95zm-7.45-3.91l1.41 1.41 1.79-1.8-1.41-1.41-1.79 1.8z"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="dark-icon" enable-background="new 0 0 24 24" height="24" viewBox="0 0 24 24" width="24"><g><rect fill="none" height="24" width="24"/></g><g><g><g><path d="M11.1,12.08C8.77,7.57,10.6,3.6,11.63,2.01C6.27,2.2,1.98,6.59,1.98,12c0,0.14,0.02,0.28,0.02,0.42 C2.62,12.15,3.29,12,4,12c1.66,0,3.18,0.83,4.1,2.15C9.77,14.63,11,16.17,11,18c0,1.52-0.87,2.83-2.12,3.51 c0.98,0.32,2.03,0.5,3.11,0.5c3.5,0,6.58-1.8,8.37-4.52C18,17.72,13.38,16.52,11.1,12.08z"/></g><path d="M7,16l-0.18,0C6.4,14.84,5.3,14,4,14c-1.66,0-3,1.34-3,3s1.34,3,3,3c0.62,0,2.49,0,3,0c1.1,0,2-0.9,2-2 C9,16.9,8.1,16,7,16z"/></g></g></svg>
</div>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" id="toggle-menu" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>

          </div>
          <input type="text" id="search" placeholder="Search... (beta)" autocomplete="off">
        </div>
      </div>
      <nav class="search hidden"></nav>
      <nav class="content hidden">
        <ul>
          <li class="open"><div class="menu-row"><a href="./index.html">README</a></div></li><li class="open"><div class="menu-row"><a href="./actions.html">actions</a></div></li><li class="open"><div class="menu-row"><a href="./actionsparser.html">actionsparser</a></div></li><li class="open"><div class="menu-row"><a href="./archiver.html">archiver</a></div></li><li class="open"><div class="menu-row"><svg xmlns="http://www.w3.org/2000/svg" class="dropdown-arrow" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M7 10l5 5 5-5z"/></svg><a href="./books.html">books</a></div><ul><li><a href="./books.chapter.html">chapter</a></li><li><a href="./books.library.html">library</a></li><li><a href="./books.pointer.html">pointer</a></li></ul></li><li class="open"><div class="menu-row"><a href="./builder.html">builder</a></div></li><li class="open"><div class="menu-row"><a href="./calc.html">calc</a></div></li><li class="open"><div class="menu-row"><a href="./coinmarketcap.html">coinmarketcap</a></div></li><li class="open"><div class="menu-row"><a href="./console.html">console</a></div></li><li class="open"><div class="menu-row"><a href="./crpgp.html">crpgp</a></div></li><li class="open"><div class="menu-row"><a href="./crystaljson.html">crystaljson</a></div></li><li class="open"><div class="menu-row"><a href="./currency.html">currency</a></div></li><li class="open"><div class="menu-row"><a href="./data.html">data</a></div></li><li class="open"><div class="menu-row"><a href="./docker.html">docker</a></div></li><li class="open"><div class="menu-row"><a href="./encoder.html">encoder</a></div></li><li class="open"><div class="menu-row"><a href="./fftools.html">fftools</a></div></li><li class="open"><div class="menu-row"><a href="./github.html">github</a></div></li><li class="open"><div class="menu-row"><a href="./gittools.html">gittools</a></div></li><li class="open"><div class="menu-row"><a href="./hostsfile.html">hostsfile</a></div></li><li class="open"><div class="menu-row"><a href="./httpconnection.html">httpconnection</a></div></li><li class="open"><div class="menu-row"><a href="./imagemagick.html">imagemagick</a></div></li><li class="open"><div class="menu-row"><svg xmlns="http://www.w3.org/2000/svg" class="dropdown-arrow" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M7 10l5 5 5-5z"/></svg><a href="#">installers</a></div><ul><li><a href="./installers.base.html">base</a></li><li><a href="./installers.caddy.html">caddy</a></li><li><a href="./installers.crystaltools.html">crystaltools</a></li><li><a href="./installers.golang.html">golang</a></li><li><a href="./installers.imagemagick.html">imagemagick</a></li><li><a href="./installers.mdbook.html">mdbook</a></li><li><a href="./installers.repository.html">repository</a></li><li><a href="./installers.rust.html">rust</a></li><li><a href="./installers.swarm.html">swarm</a></li><li><a href="./installers.tailwind.html">tailwind</a></li><li><a href="./installers.tmux.html">tmux</a></li><li><a href="./installers.vlang.html">vlang</a></li><li><a href="./installers.zdb.html">zdb</a></li></ul></li><li class="open"><div class="menu-row"><a href="./ipaddress.html">ipaddress</a></div></li><li class="open"><div class="menu-row"><a href="./jsonrpc.html">jsonrpc</a></div></li><li class="open"><div class="menu-row"><a href="./jsonschema.html">jsonschema</a></div></li><li class="open"><div class="menu-row"><svg xmlns="http://www.w3.org/2000/svg" class="dropdown-arrow" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M7 10l5 5 5-5z"/></svg><a href="./keysafe.html">keysafe</a></div><ul><li><a href="./keysafe.secp256k1.html">secp256k1</a></li></ul></li><li class="open"><div class="menu-row"><a href="./markdowndocs.html">markdowndocs</a></div></li><li class="open"><div class="menu-row"><a href="./mnemonic.html">mnemonic</a></div></li><li class="open active"><div class="menu-row"><a href="./natsclient.html">natsclient</a></div></li><li class="open"><div class="menu-row"><svg xmlns="http://www.w3.org/2000/svg" class="dropdown-arrow" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M7 10l5 5 5-5z"/></svg><a href="./openrpc.html">openrpc</a></div><ul><li><a href="./openrpc.docgen.html">docgen</a></li><li><a href="./openrpc.examples.openrpc_client.html">examples.openrpc_client</a></li></ul></li><li class="open"><div class="menu-row"><a href="./main.html">main</a></div></li><li class="open"><div class="menu-row"><svg xmlns="http://www.w3.org/2000/svg" class="dropdown-arrow" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M7 10l5 5 5-5z"/></svg><a href="./openrpc.examples.openrpc_client.html">openrpc</a></div><ul><li><a href="./openrpc.docgen.html">docgen</a></li><li><a href="./openrpc.examples.openrpc_client.html">examples.openrpc_client</a></li></ul></li><li class="open"><div class="menu-row"><a href="./openssl.html">openssl</a></div></li><li class="open"><div class="menu-row"><a href="./params.html">params</a></div></li><li class="open"><div class="menu-row"><a href="./pathlib.html">pathlib</a></div></li><li class="open"><div class="menu-row"><a href="./pgp.html">pgp</a></div></li><li class="open"><div class="menu-row"><a href="./process.html">process</a></div></li><li class="open"><div class="menu-row"><a href="./publisher2.html">publisher2</a></div></li><li class="open"><div class="menu-row"><a href="./publisher_core.html">publisher_core</a></div></li><li class="open"><div class="menu-row"><a href="./redisclient.html">redisclient</a></div></li><li class="open"><div class="menu-row"><a href="./redisserver.html">redisserver</a></div></li><li class="open"><div class="menu-row"><a href="./resp.html">resp</a></div></li><li class="open"><div class="menu-row"><a href="./rootpath.html">rootpath</a></div></li><li class="open"><div class="menu-row"><a href="./rpcwebsocket.html">rpcwebsocket</a></div></li><li class="open"><div class="menu-row"><a href="./serializers.html">serializers</a></div></li><li class="open"><div class="menu-row"><a href="./sshagent.html">sshagent</a></div></li><li class="open"><div class="menu-row"><a href="./taskletmanager.html">taskletmanager</a></div></li><li class="open"><div class="menu-row"><a href="./texttools.html">texttools</a></div></li><li class="open"><div class="menu-row"><svg xmlns="http://www.w3.org/2000/svg" class="dropdown-arrow" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M7 10l5 5 5-5z"/></svg><a href="#">threefold</a></div><ul><li><a href="./threefold.liquid.html">liquid</a></li><li><a href="./threefold.macros.html">macros</a></li><li><a href="./threefold.macros.rest.html">macros.rest</a></li><li><a href="./threefold.nodepilot.html">nodepilot</a></li><li><a href="./threefold.rmb.html">rmb</a></li><li><a href="./threefold.terraform.html">terraform</a></li><li><a href="./threefold.tfgrid.html">tfgrid</a></li><li><a href="./threefold.tokens.html">tokens</a></li><li><a href="./threefold.twinclient.html">twinclient</a></li><li><a href="./threefold.zerohub.html">zerohub</a></li></ul></li><li class="open"><div class="menu-row"><a href="./timetools.html">timetools</a></div></li><li class="open"><div class="menu-row"><a href="./tmux.html">tmux</a></div></li><li class="open"><div class="menu-row"><svg xmlns="http://www.w3.org/2000/svg" class="dropdown-arrow" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M7 10l5 5 5-5z"/></svg><a href="#">tools</a></div><ul><li><a href="./tools.cacher.html">cacher</a></li><li><a href="./tools.downloader.html">downloader</a></li></ul></li><li class="open"><div class="menu-row"><a href="./twinclient.html">twinclient</a></div></li><li class="open"><div class="menu-row"><svg xmlns="http://www.w3.org/2000/svg" class="dropdown-arrow" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M7 10l5 5 5-5z"/></svg><a href="./ui.html">ui</a></div><ul><li><a href="./ui.console.html">console</a></li><li><a href="./ui.telegram.html">telegram</a></li><li><a href="./ui.telegram.client.html">telegram.client</a></li><li><a href="./ui.uimodel.html">uimodel</a></li></ul></li><li class="open"><div class="menu-row"><a href="./vault.html">vault</a></div></li><li class="open"><div class="menu-row"><a href="./verasure.html">verasure</a></div></li><li class="open"><div class="menu-row"><a href="./vexecutor.html">vexecutor</a></div></li><li class="open"><div class="menu-row"><a href="./zdb.html">zdb</a></div></li>
        </ul>
      </nav>
    </header>
    <div class="doc-scrollview" id="main-content">
      <div class="doc-container">
        <div class="doc-content">
          						<section id="readme_natsclient" class="doc-node">
							<div class="title"><h1> natsclient <a href="#readme_natsclient">#</a></h1></div><h1>NATSClient</h1>
<p>This module implements a client that can connect with a <a href="https://nats.io/">NATS</a> server, allowing a client to exchange messages with other clients through this server. The reader is recommended to go through the <a href="https://docs.nats.io/">documentation</a> before continuing to read this document.</p>
<h2>Publishing and subscribing</h2>
<p>NATS can shortly be defined as a publish-subscribe message system. A client can publish a message to a specific subject which other clients will receive if they subscribed to that subject. Subject hierarchy can be achieved by using the <code>.</code> character:</p>
<pre><code>something.anotherthing.anotherone
</code></pre>
<p>The characters <code>*</code> (match anything from the same level in the hierarchy) and <code>&gt;</code> (match anything in this level and levels down in the hierarchy) are wildcards when used in a subscription request. Subscriptions created with the subjects defined below will all receive messages published to <code>something.anotherthing.anotherone</code>.</p>
<pre><code>something.*.anotherone
something.anotherthing.*
something.anotherthing.&gt;
something.&gt;
</code></pre>
<h2>Streams and Consumers</h2>
<p>The <a href="https://docs.nats.io/nats-concepts/core-nats">core NATS</a> does not guarantee 'at least once' service, meaning it does not guarantee that one of the clients received the message. Fortunately <a href="https://docs.nats.io/nats-concepts/jetstream">JetStream</a> (a built-in distributed persistence system) does through the concept of streams and consumers.</p>
<p>Streams are 'message stores', they define how the messages are stored (and many other things) at server side.</p>
<p>Consumers allow clients to consume messages and acknowledge the receipt of the messages, thus providing the 'at least once' service.</p>
<p>JetStream can also guarantee the 'at most once' service through a couple of API requests (and with help of its clients).</p>
<h2>NATSClient under the hood</h2>
<p>The NATSClient class implements the <a href="https://docs.nats.io/reference/reference-protocols/nats-protocol#msg">client protocol</a> allowing the client to publish and subscribe to subjects through a websocket. It can also create streams and consumers by publishing messages to system subjects. The payload of those messages should contain the configuration (json data) of each of the requests and can be found <a href="https://github.com/nats-io/jsm.go/tree/main/schemas/jetstream/api/v1">here</a>. NATS allows you to pass a reply subject when publishing the messages. NATS will use that subject to send responses to the client.</p>
<h3>Under the hood: Pulling messages from a consumer</h3>
<p>Messages can be pulled from a consumer by sending the following message:</p>
<pre><code>PUB $JS.API.CONSUMER.MSG.NEXT.mystream.myconsumer myinbox 49\r\n{&quot;expires&quot;:5000000000,&quot;batch&quot;:20,&quot;no_wait&quot;:false}\r\n
</code></pre>
<p>NATS will start consuming the messages from the consumer 'myconsumer' and will send them to the subject myinbox which the NATSClient has to subscribe to. The configuration tells NATS to:</p>
<ul>
<li>send batches of 20 messages</li>
<li>make the pull request expire after 5 seconds (5000000000 nanoseconds)</li>
<li>wait for messages until the pull request expires if there are no messages</li>
</ul>
<h3>Under the hood: Acknowledging messages</h3>
<p>In order to guarantee 'at most once' service NATS requires you to acknowledge messages. After sending a pull request NATS send the messages to the subject that was specified in the request (reply_to field). Those messages are formatted as shown <a href="https://docs.nats.io/reference/reference-protocols/nats-protocol#msg">here</a>. The class in nats_parser.v shows you how those messages can be parsed. The reply_to field in those messages will contain the system subject that should be used to acknowledge the message. It should be similar to <code>$JS.ACK.mystream.myconsumer.11.39.618.1674209322098595786.0</code>. You can then send the message shown below in order to acknowledge:</p>
<pre><code>PUB $JS.ACK.mystream.myconsumer.11.39.618.1674209322098595786.0 0\r\n\r\n
</code></pre>
<h3>Settings</h3>
<p>There are a lot of settings that can modify the behavior of NATS, the file nats_types.v contains some of them which we should still experiment with. For example:</p>
<ul>
<li>the time to wait before an acknowledgement is considered unsuccessful</li>
<li>the amount of times NATS will send the message again after an unsuccessful acknowledgement</li>
<li>whether we acknowledge all messages (default) or only the last of a batch which will acknowledge all of the messages before that</li>
<li>etc.</li>
</ul>
<h2>Run the example</h2>
<p>You need two things in order to run the example. First you need to run a natsserver using the nats configuration that you can find in example/nats_configuration.json. You can specify that you want to enable jetstream using the -js argument.</p>
<pre><code>nats-server -c example/nats_configuration.json -js -DV
</code></pre>
<p>Now you can run the example:</p>
<pre><code>v run example/test_natsclient.v
</code></pre>
<p>This test consumes messages send to &quot;ORDERS.*&quot;. It will also create a key-value store, add a key and fetch it. To test the incoming messages you can run:</p>
<pre><code>nats publish ORDERS.NEW &quot;this is my message&quot;
</code></pre>
<p>If you want to test batch messages you can add the argument --count=&lt;SOMEVALUE&gt;</p>
<h2>How to contribute</h2>
<p>There is still a lot to experiment with:</p>
<ul>
<li>For now the messages are being acknowledged after receiving them. We might want to change that behavior. We could allow users of the NATSClient class to acknowledge them themselves. This could introduce only acknowledge messages when they have been fully processed by the user.</li>
<li>We should experiment with the many settings provided by NATS</li>
<li>We could either use redis or a channel to pass the received messages to the user of NATSClient. Redis would make it more persistent while a channel would be more performant. The choice will depend on the user of the NATSClient. Maybe we can provide both.</li>
<li>Many of the publish messages in NATSClient do not use a reply_to subject, meaning NATS will not send a response on the request. We should experiment with the reply_to subject. This might help introducing failsafes (sending the acknowledgement again if it failed, etc).</li>
<li>Testing the NATSClient</li>
<li>Opening up a key value store to the user. The nats-cli is doing this using a stream with specific settings (you can see some logs below). They set the max_msgs_per_subject to 1. Adding a key-value to the store boils down to publishing a message (value) to a subject (key). The logs when running the command <code>nats kv add mykvstore</code>:</li>
</ul>
<pre><code>    PUB $JS.API.STREAM.CREATE.KV_mykvstore _INBOX.XOYl5CWiVL1vUPwgo8WAvh.lsgIf50w 378
    {\&quot;name\&quot;:\&quot;KV_mykvstore\&quot;,\&quot;subjects\&quot;:[\&quot;$KV.mykvstore.\\u003e\&quot;],\&quot;retention\&quot;:\&quot;limits\&quot;,\&quot;max_consumers\&quot;:-1,\&quot;max_msgs\&quot;:-1,\&quot;max_bytes\&quot;:-1,\&quot;discard\&quot;:\&quot;new\&quot;,\&quot;max_age\&quot;:0,\&quot;max_msgs_per_subject\&quot;:1,\&quot;max_msg_size\&quot;:-1,\&quot;storage\&quot;:\&quot;file\&quot;,\&quot;num_replicas\&quot;:1,\&quot;duplicate_window\&quot;:120000000000,\&quot;placement\&quot;:{\&quot;cluster\&quot;:\&quot;\&quot;},\&quot;deny_delete\&quot;:true,\&quot;allow_rollup_hdrs\&quot;:true,\&quot;allow_direct\&quot;:true,\&quot;mirror_direct\&quot;:false}
</code></pre>

</section>

						<section id="Constants" class="doc-node const">
							<div class="title"><h2>Constants <a href="#Constants">#</a></h2></div>

</section>
						<section id="" class="doc-node const">
<pre class="signature"><code><span class="token keyword">const</span> natsclient_version <span class="token operator">=</span><span class="token string">''</span>$2{natsclient_version_major}.${natsclient_version_minor}.${natsclient_version_patch}'</code></pre>


</section>
						<section id="new_natsclient" class="doc-node">
							<div class="title"><h2>fn new_natsclient <a href="#new_natsclient">#</a></h2><a class="link" rel="noreferrer" target="_blank" href="https://github.com/freeflowuniverse/crystallib/blob/master/crystallib/natsclient/nats_client.v#L315"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></div><pre class="signature"><code><span class="token keyword">fn</span> <span class="token function">new_natsclient</span><span class="token punctuation">(</span>address <span class="token builtin">string</span><span class="token punctuation">,</span> ch_messages <span class="token builtin">chan</span> NATSMessage<span class="token punctuation">,</span> ch_keyvalue <span class="token builtin">chan</span> NATSKeyValue<span class="token punctuation">,</span> logger <span class="token operator">&</span>log<span class="token punctuation">.</span>Logger<span class="token punctuation">)</span> <span class="token operator">!</span><span class="token operator">&</span>NATSClient</code></pre>


</section>
						<section id="ConsumerNextMSG" class="doc-node">
							<div class="title"><h2>struct ConsumerNextMSG <a href="#ConsumerNextMSG">#</a></h2><a class="link" rel="noreferrer" target="_blank" href="https://github.com/freeflowuniverse/crystallib/blob/master/crystallib/natsclient/nats_types.v#L136"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></div><pre class="signature"><code><span class="token keyword">struct</span> <span class="token symbol">ConsumerNextMSG</span> <span class="token punctuation">{</span>
<span class="token comment">// A duration from now when the pull should expire, stated in nanoseconds, 0 for no expiry</span>
	expires <span class="token builtin">i64</span>
<span class="token comment">// How many messages the server should deliver to the requestor</span>
	batch <span class="token builtin">int</span>
<span class="token comment">// Sends at most this many bytes to the requestor, limited by consumer configuration max_bytes</span>
<span class="token comment">// max_bytes int</span>
<span class="token comment">// When true a response with a 404 status header will be returned when no messages are available (default false)</span>
	no_wait <span class="token builtin">bool</span>
<span class="token comment">// When not 0 idle heartbeats will be sent on this interval</span>
<span class="token comment">// idle_heartbeat int</span>
<span class="token punctuation">}</span></code></pre>
<p>configuration for pulling the next message(s) from a consumer</p>

</section>
						<section id="NATSClient" class="doc-node">
							<div class="title"><h2>struct NATSClient <a href="#NATSClient">#</a></h2><a class="link" rel="noreferrer" target="_blank" href="https://github.com/freeflowuniverse/crystallib/blob/master/crystallib/natsclient/nats_client.v#L30"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></div><pre class="signature"><code><span class="token keyword">struct</span> <span class="token symbol">NATSClient</span> <span class="token punctuation">{</span>
<span class="token keyword">mut</span><span class="token punctuation">:</span>
	uuid                <span class="token builtin">string</span>
	myinbox             <span class="token builtin">string</span>
	websocket           <span class="token operator">&</span>websocket<span class="token punctuation">.</span>Client
	address             <span class="token builtin">string</span>
	stream_to_consumers <span class="token builtin">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>ConsumerList

	ch_messages   <span class="token builtin">chan</span> NATSMessage
	ch_keyvalue   <span class="token builtin">chan</span> NATSKeyValue
	natsmsgparser <span class="token operator">&</span>NATSMessageParser
<span class="token keyword">pub</span> <span class="token keyword">mut</span><span class="token punctuation">:</span>
<span class="token comment">// pull every 5 seconds</span>
	pull_frequency <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">5</span>
	logger         <span class="token operator">&</span>log<span class="token punctuation">.</span>Logger
<span class="token punctuation">}</span></code></pre>


</section>
						<section id="NATSClient.ack_message" class="doc-node">
							<div class="title"><h2>fn (NATSClient) ack_message <a href="#NATSClient.ack_message">#</a></h2><a class="link" rel="noreferrer" target="_blank" href="https://github.com/freeflowuniverse/crystallib/blob/master/crystallib/natsclient/nats_client.v#L55"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></div><pre class="signature"><code><span class="token keyword">fn</span> <span class="token punctuation">(</span><span class="token keyword">mut</span> cl NATSClient<span class="token punctuation">)</span> <span class="token function">ack_message</span><span class="token punctuation">(</span>ack_subject <span class="token builtin">string</span><span class="token punctuation">)</span></code></pre>


</section>
						<section id="NATSClient.create_stream" class="doc-node">
							<div class="title"><h2>fn (NATSClient) create_stream <a href="#NATSClient.create_stream">#</a></h2><a class="link" rel="noreferrer" target="_blank" href="https://github.com/freeflowuniverse/crystallib/blob/master/crystallib/natsclient/nats_client.v#L63"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></div><pre class="signature"><code><span class="token keyword">fn</span> <span class="token punctuation">(</span><span class="token keyword">mut</span> cl NATSClient<span class="token punctuation">)</span> <span class="token function">create_stream</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> subjects <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">!</span></code></pre>


</section>
						<section id="NATSClient.create_consumer" class="doc-node">
							<div class="title"><h2>fn (NATSClient) create_consumer <a href="#NATSClient.create_consumer">#</a></h2><a class="link" rel="noreferrer" target="_blank" href="https://github.com/freeflowuniverse/crystallib/blob/master/crystallib/natsclient/nats_client.v#L79"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></div><pre class="signature"><code><span class="token keyword">fn</span> <span class="token punctuation">(</span><span class="token keyword">mut</span> cl NATSClient<span class="token punctuation">)</span> <span class="token function">create_consumer</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> stream <span class="token builtin">string</span><span class="token punctuation">,</span> description <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">!</span></code></pre>


</section>
						<section id="NATSClient.subscribe" class="doc-node">
							<div class="title"><h2>fn (NATSClient) subscribe <a href="#NATSClient.subscribe">#</a></h2><a class="link" rel="noreferrer" target="_blank" href="https://github.com/freeflowuniverse/crystallib/blob/master/crystallib/natsclient/nats_client.v#L121"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></div><pre class="signature"><code><span class="token keyword">fn</span> <span class="token punctuation">(</span><span class="token keyword">mut</span> cl NATSClient<span class="token punctuation">)</span> <span class="token function">subscribe</span><span class="token punctuation">(</span>subject <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">!</span><span class="token builtin">string</span></code></pre>


</section>
						<section id="NATSClient.publish" class="doc-node">
							<div class="title"><h2>fn (NATSClient) publish <a href="#NATSClient.publish">#</a></h2><a class="link" rel="noreferrer" target="_blank" href="https://github.com/freeflowuniverse/crystallib/blob/master/crystallib/natsclient/nats_client.v#L132"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></div><pre class="signature"><code><span class="token keyword">fn</span> <span class="token punctuation">(</span><span class="token keyword">mut</span> cl NATSClient<span class="token punctuation">)</span> <span class="token function">publish</span><span class="token punctuation">(</span>subject <span class="token builtin">string</span><span class="token punctuation">,</span> reply_to <span class="token builtin">string</span><span class="token punctuation">,</span> message <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">!</span></code></pre>


</section>
						<section id="NATSClient.hpublish" class="doc-node">
							<div class="title"><h2>fn (NATSClient) hpublish <a href="#NATSClient.hpublish">#</a></h2><a class="link" rel="noreferrer" target="_blank" href="https://github.com/freeflowuniverse/crystallib/blob/master/crystallib/natsclient/nats_client.v#L146"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></div><pre class="signature"><code><span class="token keyword">fn</span> <span class="token punctuation">(</span><span class="token keyword">mut</span> cl NATSClient<span class="token punctuation">)</span> <span class="token function">hpublish</span><span class="token punctuation">(</span>subject <span class="token builtin">string</span><span class="token punctuation">,</span> headers <span class="token builtin">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> reply_to <span class="token builtin">string</span><span class="token punctuation">,</span> message <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">!</span></code></pre>


</section>
						<section id="NATSClient.create_keyvalue_store" class="doc-node">
							<div class="title"><h2>fn (NATSClient) create_keyvalue_store <a href="#NATSClient.create_keyvalue_store">#</a></h2><a class="link" rel="noreferrer" target="_blank" href="https://github.com/freeflowuniverse/crystallib/blob/master/crystallib/natsclient/nats_client.v#L164"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></div><pre class="signature"><code><span class="token keyword">fn</span> <span class="token punctuation">(</span><span class="token keyword">mut</span> cl NATSClient<span class="token punctuation">)</span> <span class="token function">create_keyvalue_store</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">!</span></code></pre>


</section>
						<section id="NATSClient.add_keyvalue" class="doc-node">
							<div class="title"><h2>fn (NATSClient) add_keyvalue <a href="#NATSClient.add_keyvalue">#</a></h2><a class="link" rel="noreferrer" target="_blank" href="https://github.com/freeflowuniverse/crystallib/blob/master/crystallib/natsclient/nats_client.v#L191"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></div><pre class="signature"><code><span class="token keyword">fn</span> <span class="token punctuation">(</span><span class="token keyword">mut</span> cl NATSClient<span class="token punctuation">)</span> <span class="token function">add_keyvalue</span><span class="token punctuation">(</span>store <span class="token builtin">string</span><span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">!</span></code></pre>


</section>
						<section id="NATSClient.set_value" class="doc-node">
							<div class="title"><h2>fn (NATSClient) set_value <a href="#NATSClient.set_value">#</a></h2><a class="link" rel="noreferrer" target="_blank" href="https://github.com/freeflowuniverse/crystallib/blob/master/crystallib/natsclient/nats_client.v#L198"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></div><pre class="signature"><code><span class="token keyword">fn</span> <span class="token punctuation">(</span><span class="token keyword">mut</span> cl NATSClient<span class="token punctuation">)</span> <span class="token function">set_value</span><span class="token punctuation">(</span>store <span class="token builtin">string</span><span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">!</span></code></pre>


</section>
						<section id="NATSClient.get_value" class="doc-node">
							<div class="title"><h2>fn (NATSClient) get_value <a href="#NATSClient.get_value">#</a></h2><a class="link" rel="noreferrer" target="_blank" href="https://github.com/freeflowuniverse/crystallib/blob/master/crystallib/natsclient/nats_client.v#L204"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></div><pre class="signature"><code><span class="token keyword">fn</span> <span class="token punctuation">(</span><span class="token keyword">mut</span> cl NATSClient<span class="token punctuation">)</span> <span class="token function">get_value</span><span class="token punctuation">(</span>store <span class="token builtin">string</span><span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">!</span></code></pre>


</section>
						<section id="NATSClient.listen" class="doc-node">
							<div class="title"><h2>fn (NATSClient) listen <a href="#NATSClient.listen">#</a></h2><a class="link" rel="noreferrer" target="_blank" href="https://github.com/freeflowuniverse/crystallib/blob/master/crystallib/natsclient/nats_client.v#L304"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></div><pre class="signature"><code><span class="token keyword">fn</span> <span class="token punctuation">(</span><span class="token keyword">mut</span> cl NATSClient<span class="token punctuation">)</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!</span></code></pre>


</section>
						<section id="NATSKeyValue" class="doc-node">
							<div class="title"><h2>struct NATSKeyValue <a href="#NATSKeyValue">#</a></h2><a class="link" rel="noreferrer" target="_blank" href="https://github.com/freeflowuniverse/crystallib/blob/master/crystallib/natsclient/nats_types.v#L3"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></div><pre class="signature"><code><span class="token keyword">struct</span> <span class="token symbol">NATSKeyValue</span> <span class="token punctuation">{</span>
<span class="token keyword">pub</span> <span class="token keyword">mut</span><span class="token punctuation">:</span>
	store     <span class="token builtin">string</span>
	key       <span class="token builtin">string</span>
	value     <span class="token builtin">string</span>
	timestamp <span class="token builtin">string</span>
<span class="token punctuation">}</span></code></pre>


</section>
						<section id="NATSMessage" class="doc-node">
							<div class="title"><h2>struct NATSMessage <a href="#NATSMessage">#</a></h2><a class="link" rel="noreferrer" target="_blank" href="https://github.com/freeflowuniverse/crystallib/blob/master/crystallib/natsclient/nats_parser.v#L8"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></div><pre class="signature"><code><span class="token keyword">struct</span> <span class="token symbol">NATSMessage</span> <span class="token punctuation">{</span>
<span class="token keyword">pub</span> <span class="token keyword">mut</span><span class="token punctuation">:</span>
	subject  <span class="token builtin">string</span>
	sid      <span class="token builtin">string</span>
	reply_to <span class="token builtin">string</span>
	message  <span class="token builtin">string</span>
<span class="token punctuation">}</span></code></pre>


</section>
						<section id="NATSMessageParser" class="doc-node">
							<div class="title"><h2>struct NATSMessageParser <a href="#NATSMessageParser">#</a></h2><a class="link" rel="noreferrer" target="_blank" href="https://github.com/freeflowuniverse/crystallib/blob/master/crystallib/natsclient/nats_parser.v#L16"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></div><pre class="signature"><code><span class="token keyword">struct</span> <span class="token symbol">NATSMessageParser</span> <span class="token punctuation">{</span>
<span class="token keyword">mut</span><span class="token punctuation">:</span>
	data           <span class="token builtin">string</span>
	i              <span class="token builtin">int</span>
	subject        <span class="token builtin">string</span>
	sid            <span class="token builtin">string</span>
	reply_to       <span class="token builtin">string</span>
	message_length <span class="token builtin">int</span>
	message        <span class="token builtin">string</span>
	header_length  <span class="token builtin">int</span>
	headers        <span class="token builtin">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span>
<span class="token keyword">pub</span> <span class="token keyword">mut</span><span class="token punctuation">:</span>
	on_nats_message <span class="token keyword">fn</span> <span class="token punctuation">(</span>message NATSMessage<span class="token punctuation">,</span> headers <span class="token builtin">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">fn</span> <span class="token punctuation">(</span>message NATSMessage<span class="token punctuation">,</span> headers <span class="token builtin">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
	on_nats_info    <span class="token keyword">fn</span> <span class="token punctuation">(</span>data <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">fn</span> <span class="token punctuation">(</span>data <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
	on_nats_ping    <span class="token keyword">fn</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">fn</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
	on_nats_pong    <span class="token keyword">fn</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">fn</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
	on_nats_error   <span class="token keyword">fn</span> <span class="token punctuation">(</span>error <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">fn</span> <span class="token punctuation">(</span>error <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>


</section>
						<section id="NATSMessageParser.parse" class="doc-node">
							<div class="title"><h2>fn (NATSMessageParser) parse <a href="#NATSMessageParser.parse">#</a></h2><a class="link" rel="noreferrer" target="_blank" href="https://github.com/freeflowuniverse/crystallib/blob/master/crystallib/natsclient/nats_parser.v#L35"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></div><pre class="signature"><code><span class="token keyword">fn</span> <span class="token punctuation">(</span><span class="token keyword">mut</span> n NATSMessageParser<span class="token punctuation">)</span> <span class="token function">parse</span><span class="token punctuation">(</span>data <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">!</span></code></pre>


</section>
						<section id="NATSMessageParser.parse_err" class="doc-node">
							<div class="title"><h2>fn (NATSMessageParser) parse_err <a href="#NATSMessageParser.parse_err">#</a></h2><a class="link" rel="noreferrer" target="_blank" href="https://github.com/freeflowuniverse/crystallib/blob/master/crystallib/natsclient/nats_parser.v#L94"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></div><pre class="signature"><code><span class="token keyword">fn</span> <span class="token punctuation">(</span><span class="token keyword">mut</span> n NATSMessageParser<span class="token punctuation">)</span> <span class="token function">parse_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!</span><span class="token builtin">string</span></code></pre>
<hr>

</section>
						<section id="NATSMessageParser.parse_info" class="doc-node">
							<div class="title"><h2>fn (NATSMessageParser) parse_info <a href="#NATSMessageParser.parse_info">#</a></h2><a class="link" rel="noreferrer" target="_blank" href="https://github.com/freeflowuniverse/crystallib/blob/master/crystallib/natsclient/nats_parser.v#L112"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></div><pre class="signature"><code><span class="token keyword">fn</span> <span class="token punctuation">(</span><span class="token keyword">mut</span> n NATSMessageParser<span class="token punctuation">)</span> <span class="token function">parse_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!</span><span class="token builtin">string</span></code></pre>
<hr>

</section>
						<section id="NATSMessageParser.parse_hmsg" class="doc-node">
							<div class="title"><h2>fn (NATSMessageParser) parse_hmsg <a href="#NATSMessageParser.parse_hmsg">#</a></h2><a class="link" rel="noreferrer" target="_blank" href="https://github.com/freeflowuniverse/crystallib/blob/master/crystallib/natsclient/nats_parser.v#L129"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></div><pre class="signature"><code><span class="token keyword">fn</span> <span class="token punctuation">(</span><span class="token keyword">mut</span> n NATSMessageParser<span class="token punctuation">)</span> <span class="token function">parse_hmsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!</span></code></pre>


</section>
						<section id="NATSMessageParser.parse_msg" class="doc-node">
							<div class="title"><h2>fn (NATSMessageParser) parse_msg <a href="#NATSMessageParser.parse_msg">#</a></h2><a class="link" rel="noreferrer" target="_blank" href="https://github.com/freeflowuniverse/crystallib/blob/master/crystallib/natsclient/nats_parser.v#L177"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></div><pre class="signature"><code><span class="token keyword">fn</span> <span class="token punctuation">(</span><span class="token keyword">mut</span> n NATSMessageParser<span class="token punctuation">)</span> <span class="token function">parse_msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!</span></code></pre>
<hr>

</section>
						<section id="ConnectConfig" class="doc-node">
							<div class="title"><h2>struct ConnectConfig <a href="#ConnectConfig">#</a></h2><a class="link" rel="noreferrer" target="_blank" href="https://github.com/freeflowuniverse/crystallib/blob/master/crystallib/natsclient/nats_types.v#L14"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></div><pre class="signature"><code><span class="token keyword">struct</span> <span class="token symbol">ConnectConfig</span> <span class="token punctuation">{</span>
	verbose       <span class="token builtin">bool</span>
	pedantic      <span class="token builtin">bool</span>
	tls_required  <span class="token builtin">bool</span>
	name          <span class="token builtin">string</span>
	lang          <span class="token builtin">string</span>
	version       <span class="token builtin">string</span>
	protocol      <span class="token builtin">int</span>
	echo          <span class="token builtin">bool</span>
	headers       <span class="token builtin">bool</span>
	no_responders <span class="token builtin">bool</span>
<span class="token punctuation">}</span></code></pre>
<p>Configuration of all possible publish messages can be found at: <a href="https://github.com/nats-io/jsm.go/tree/main/schemas/jetstream/api/v1">https://github.com/nats-io/jsm.go/tree/main/schemas/jetstream/api/v1</a></p>

</section>
						<section id="StreamConfig" class="doc-node">
							<div class="title"><h2>struct StreamConfig <a href="#StreamConfig">#</a></h2><a class="link" rel="noreferrer" target="_blank" href="https://github.com/freeflowuniverse/crystallib/blob/master/crystallib/natsclient/nats_types.v#L27"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></div><pre class="signature"><code><span class="token keyword">struct</span> <span class="token symbol">StreamConfig</span> <span class="token punctuation">{</span>
<span class="token comment">// A unique name for the Stream, empty for Stream Templates.</span>
	name <span class="token builtin">string</span>
<span class="token comment">// A short description of the purpose of this stream</span>
	description <span class="token builtin">string</span>
<span class="token comment">// A list of subjects to consume, supports wildcards. Must be empty when a mirror is configured. May be empty when sources are configured.</span>
	subjects <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
<span class="token comment">// How messages are retained in the Stream, once this is exceeded old messages are removed. Should be one of:</span>
<span class="token comment">// 	limits = (default)</span>
<span class="token comment">// 	interest =</span>
<span class="token comment">// 	workqueue"</span>
	retention <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">'limits'</span>
<span class="token comment">// How many Consumers can be defined for a given Stream. -1 for unlimited. (default -1)</span>
	max_consumers <span class="token builtin">i64</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
<span class="token comment">// How many messages may be in a Stream, oldest messages will be removed if the Stream exceeds this size. -1 for unlimited. (default -1)</span>
	max_msgs <span class="token builtin">i64</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
<span class="token comment">// For wildcard streams ensure that for every unique subject this many messages are kept - a per subject retention limit (default -1)</span>
	max_msgs_per_subject <span class="token builtin">i64</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
<span class="token comment">// How big the Stream may be, when the combined stream size exceeds this old messages are removed. -1 for unlimited. (default -1)</span>
	max_bytes <span class="token builtin">i64</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
<span class="token comment">// Maximum age of any message in the stream, expressed in nanoseconds. 0 for unlimited. (default 0)</span>
	max_age <span class="token builtin">i64</span> <span class="token operator">=</span> <span class="token number">0</span>
<span class="token comment">// The largest message that will be accepted by the Stream. -1 for unlimited. (default -1)</span>
	max_msg_size <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
<span class="token comment">// The storage backend to use for the Stream. One of: "file" (default), "memory"</span>
	storage <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">'file'</span>
<span class="token comment">// How many replicas to keep for each message, best to choose 1 (no security), 3 (secure and performant) or 5 (super secure, no performance) (default 1, max 5)</span>
	num_replicas <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token comment">// Disables acknowledging messages that are received by the Stream. (default false)</span>
<span class="token comment">// no_ack bool</span>
<span class="token comment">// When the Stream is managed by a Stream Template this identifies the template that manages the Stream.</span>
<span class="token comment">// template_owner string	//Restricts the ability to purge messages from a stream via the API. Cannot be change once set to true</span>
<span class="token comment">// 	tags []string</span>
<span class="token comment">//}</span>
<span class="token comment">// When a Stream reach it's limits either old messages are deleted or new ones are denied. Should be "new" or "old"</span>
	discard <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">'old'</span>
<span class="token comment">// The time window to track duplicate messages for, expressed in nanoseconds. 0 for default"</span>
	duplicate_window <span class="token builtin">i64</span> <span class="token operator">=</span> <span class="token number">0</span>
<span class="token comment">// Placement directives to consider when placing replicas of this stream, random placement when unset"</span>
	placement <span class="token keyword">struct</span> <span class="token punctuation">{</span>
		cluster <span class="token builtin">string</span>
	<span class="token punctuation">}</span>
<span class="token comment">// Sealed streams do not allow messages to be deleted via limits or API, sealed streams can not be unsealed via configuration update. Can only be set on already created streams via the Update API</span>
<span class="token comment">// sealed bool = false</span>
<span class="token comment">// Restricts the ability to delete messages from a stream via the API. Cannot be changed once set to true</span>
	deny_delete <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token comment">// Restricts the ability to purge messages from a stream via the API. Cannot be change once set to true</span>
<span class="token comment">// deny_purge bool = false</span>
<span class="token comment">// Allows the use of the Nats-Rollup header to replace all contents of a stream, or subject in a stream, with a single new message</span>
	allow_rollup_hdrs <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token comment">// Allow higher performance, direct access to get individual messages</span>
	allow_direct <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token comment">// Allow higher performance, direct access for mirrors as well"</span>
	mirror_direct <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token comment">// Rules for republishing messages from a stream with subject mapping onto new subjects for partitioning and more</span>
<span class="token comment">// republish struct {</span>
<span class="token comment">// The source object to republish</span>
<span class="token comment">// src string</span>
<span class="token comment">// The destination to publish to</span>
<span class="token comment">// dest string</span>
<span class="token comment">// Only send message headers, no bodies</span>
<span class="token comment">// headers_only bool = false</span>
<span class="token comment">//}</span>
<span class="token comment">// When discard policy is new and the stream is one with max messages per subject set, this will apply the new behavior to every subject. Essentially turning discard new from maximum number of subjects into maximum number of messages in a subject.</span>
<span class="token comment">// discard_new_per_subject bool = false</span>
<span class="token punctuation">}</span></code></pre>


</section>
						<section id="ConsumerConfig" class="doc-node">
							<div class="title"><h2>struct ConsumerConfig <a href="#ConsumerConfig">#</a></h2><a class="link" rel="noreferrer" target="_blank" href="https://github.com/freeflowuniverse/crystallib/blob/master/crystallib/natsclient/nats_types.v#L95"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></div><pre class="signature"><code><span class="token keyword">struct</span> <span class="token symbol">ConsumerConfig</span> <span class="token punctuation">{</span>
	stream_name <span class="token builtin">string</span>
	config      <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// TODO experiment with the configuration parameters below</span>
	<span class="token comment">// A unique name for a consumer</span>
		name <span class="token builtin">string</span>
	<span class="token comment">// A short description of the purpose of this consumer</span>
		description <span class="token builtin">string</span>
	<span class="token comment">// Should be one of:</span>
	<span class="token comment">//   none: messages must not be acknowledged</span>
	<span class="token comment">//   all: only acknowledge the last message of a series of messages, all others will be acknowledged too</span>
	<span class="token comment">//   explicit: each message must be acknowledged</span>
		ack_policy <span class="token builtin">string</span>
	<span class="token comment">// How long (in nanoseconds) to allow messages to remain un-acknowledged before attempting redelivery (default 30000000000)</span>
	<span class="token comment">// ack_wait int</span>
	<span class="token comment">// The number of times a message will be redelivered to consumers if not acknowledged in time // default -1</span>
	<span class="token comment">// max_deliver int</span>
	<span class="token comment">// Filter which messages you want to receive from the stream</span>
	<span class="token comment">// filter_subject string</span>
	<span class="token comment">// Should be one of:</span>
	<span class="token comment">//   instant = receive all message as fast as possible (default)</span>
	<span class="token comment">//   original = receive messages in the timing they were published</span>
	<span class="token comment">// replay_policy string</span>
	<span class="token comment">// The maximum number of messages without acknowledgement that can be outstanding, once this limit is reached message delivery will be suspended (default 1000)</span>
	<span class="token comment">// max_ack_pending int</span>
	<span class="token comment">// The number of pulls that can be outstanding on a pull consumer, pulls received after this is reached are ignored (default 512)</span>
	<span class="token comment">// max_waiting int</span>
	<span class="token comment">// The largest batch property that may be specified when doing a pull on a Pull Consumer (default 0)</span>
	<span class="token comment">// max_batch int</span>
	<span class="token comment">// The maximum expires value that may be set when doing a pull on a Pull Consumer</span>
	<span class="token comment">// max_expires int</span>
	<span class="token comment">// The maximum bytes value that maybe set when dong a pull on a Pull Consumer (default 0)</span>
	<span class="token comment">// max_bytes int</span>
	<span class="token comment">// When set do not inherit the replica count from the stream but specifically set it to this amount</span>
		num_replicas <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">1</span>
	<span class="token comment">// Force the consumer state to be kept in memory rather than inherit the setting from the stream (default false)</span>
	<span class="token comment">// mem_state bool</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>configuration for creating a consumer</p>

</section>

          <div class="footer">
            Powered by vdoc.
          </div>
        </div>
        <div class="doc-toc"><ul><li class="open"><a href="#readme_natsclient">README</a></li>
<li class="open"><a href="#Constants">Constants</a></li>
<li class="open"><a href="#new_natsclient">fn new_natsclient</a>        <ul>
</ul>
</li>
<li class="open"><a href="#ConsumerNextMSG">struct ConsumerNextMSG</a>        <ul>
</ul>
</li>
<li class="open"><a href="#NATSClient">struct NATSClient</a>        <ul>
<li><a href="#NATSClient.ack_message">fn ack_message</a></li>
<li><a href="#NATSClient.create_stream">fn create_stream</a></li>
<li><a href="#NATSClient.create_consumer">fn create_consumer</a></li>
<li><a href="#NATSClient.subscribe">fn subscribe</a></li>
<li><a href="#NATSClient.publish">fn publish</a></li>
<li><a href="#NATSClient.hpublish">fn hpublish</a></li>
<li><a href="#NATSClient.create_keyvalue_store">fn create_keyvalue_store</a></li>
<li><a href="#NATSClient.add_keyvalue">fn add_keyvalue</a></li>
<li><a href="#NATSClient.set_value">fn set_value</a></li>
<li><a href="#NATSClient.get_value">fn get_value</a></li>
<li><a href="#NATSClient.listen">fn listen</a></li>
</ul>
</li>
<li class="open"><a href="#NATSKeyValue">struct NATSKeyValue</a>        <ul>
</ul>
</li>
<li class="open"><a href="#NATSMessage">struct NATSMessage</a>        <ul>
</ul>
</li>
<li class="open"><a href="#NATSMessageParser">struct NATSMessageParser</a>        <ul>
<li><a href="#NATSMessageParser.parse">fn parse</a></li>
<li><a href="#NATSMessageParser.parse_err">fn parse_err</a></li>
<li><a href="#NATSMessageParser.parse_info">fn parse_info</a></li>
<li><a href="#NATSMessageParser.parse_hmsg">fn parse_hmsg</a></li>
<li><a href="#NATSMessageParser.parse_msg">fn parse_msg</a></li>
</ul>
</li>
<li class="open"><a href="#ConnectConfig">struct ConnectConfig</a>        <ul>
</ul>
</li>
<li class="open"><a href="#StreamConfig">struct StreamConfig</a>        <ul>
</ul>
</li>
<li class="open"><a href="#ConsumerConfig">struct ConsumerConfig</a>        <ul>
</ul>
</li>
</ul></div>
      </div>
    </div>
  </div>
  <script src="doc.js"></script>
  <script async src="search_index.js"></script>
</body>

</html>
